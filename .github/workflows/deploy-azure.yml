name: Deploy to Azure VM

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allow manual deployment

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    services:
      postgres:
        image: timescale/timescaledb-ha:pg16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    # Backend tests
    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        enable-cache: true

    - name: Install backend dependencies
      working-directory: ./backend
      run: |
        uv sync

    - name: Run backend tests
      working-directory: ./backend
      run: |
        uv run pytest
      env:
        PROJECT_NAME: "Test Project"
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test
        POSTGRES_SERVER: localhost
        POSTGRES_PORT: 5432
        POSTGRES_DB: test
        POSTGRES_USER: postgres
        POSTGRES_PASSWORD: postgres
        SECRET_KEY: test-secret-key
        FIRST_SUPERUSER: admin@example.com
        FIRST_SUPERUSER_PASSWORD: testpass123
        EMAIL_TEST_USER: test@example.com
        OPENAI_API_KEY: sk-test-key-not-real
        OPENAI_MODEL: gpt-4
        OPENAI_EMBEDDING_MODEL: text-embedding-3-small
    
    # Frontend tests
    - name: Install frontend dependencies
      working-directory: ./frontend
      run: npm ci

    - name: Run frontend lint
      working-directory: ./frontend
      run: npm run lint:ci
      timeout-minutes: 3

    - name: Run frontend build
      working-directory: ./frontend
      run: npm run build
      env:
        NODE_OPTIONS: --max-old-space-size=4096

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to Azure VM
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.AZURE_VM_HOST }}
        username: ${{ secrets.AZURE_VM_USER }}
        key: ${{ secrets.AZURE_VM_SSH_KEY }}
        port: ${{ secrets.AZURE_VM_PORT || '22' }}
        script: |
          cd ~/rocket-genai-v2

          # Pull latest code
          echo "üì• Pulling latest code..."
          git pull origin main

          # Build and restart services
          echo "üî® Building and restarting services..."
          docker compose -f docker-compose.yml build
          docker compose -f docker-compose.yml up -d

          # Wait for services
          echo "‚è≥ Waiting for services to be ready..."
          sleep 15

          # Show status
          echo "üìä Service Status:"
          docker compose ps

          # Show recent logs
          echo "üìù Recent logs:"
          docker compose logs --tail=20

          echo "üéâ Deployment completed at $(date)"

    - name: Deployment Status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "‚úÖ Deployment successful!"
          echo "üåê Application: https://dashboard.flow.cunda.io"
          echo "üìö API Docs: https://api.flow.cunda.io/docs"
        else
          echo "‚ùå Deployment failed!"
          echo "Check the logs above for details."
        fi
---
alwaysApply: false
---
# Backend Guidelines

## Project Structure
```
backend/
├── app/
│   ├── api/                # API endpoints and routers
│   │   └── v1/
│   │       ├── api.py      # Main router configuration
│   │       ├── dependencies.py # API dependencies
│   │       └── endpoints/  # API endpoint modules
│   ├── core/               # Core configuration and base classes
│   │   ├── base_crud.py    # Base CRUD implementation
│   │   ├── config.py       # Application settings
│   │   ├── security.py     # Security utilities
│   │   └── db.py           # Database setup
│   ├── common/             # Shared utilities and schemas
│   ├── modules/            # Domain modules
│   │   ├── users/          # User module
│   │   └── items/          # Items module
│   ├── tests/              # Test suites
│   ├── alembic/            # Database migrations
│   └── main.py             # FastAPI application
├── pyproject.toml          # Dependencies and tools config
└── alembic.ini             # Alembic configuration
```

## Core Technologies
- FastAPI with Python 3.10+
- SQLModel for ORM
- Pydantic for data validation
- PostgreSQL database
- JWT for authentication
- Alembic for migrations

## Module Structure
Each domain module follows this structure:
```
modules/module_name/
├── __init__.py
├── models.py      # SQLModel models for database tables
├── schemas.py     # Pydantic schemas for API I/O
├── repository.py  # Database operations
└── service.py     # Business logic and service layer
```

## Model Pattern
```python
# models.py
import uuid
from sqlmodel import Field, SQLModel, Relationship

class Item(SQLModel, table=True):
    id: uuid.UUID = Field(default_factory=uuid.uuid4, primary_key=True)
    title: str = Field(max_length=255)
    description: str | None = Field(default=None)
    owner_id: uuid.UUID = Field(foreign_key="user.id", ondelete="CASCADE")
    owner: "User" = Relationship(back_populates="items")
```

## Schema Pattern
```python
# schemas.py
import uuid
from sqlmodel import Field, SQLModel

# Base properties shared by create/update operations
class ItemBase(SQLModel):
    title: str = Field(min_length=1, max_length=255)
    description: str | None = Field(default=None, max_length=255)

# Properties for item creation
class ItemCreate(ItemBase):
    pass

# Properties for item update (all fields optional)
class ItemUpdate(SQLModel):
    title: str | None = Field(default=None, min_length=1)
    description: str | None = None

# Response model
class ItemPublic(ItemBase):
    id: uuid.UUID
    owner_id: uuid.UUID

# List response model
class ItemsPublic(SQLModel):
    data: list[ItemPublic]
    count: int
```

## Repository Pattern
```python
# repository.py
import uuid
from typing import List, Optional
from sqlmodel import Session, select, delete

from app.core.base_crud import BaseCRUD
from .models import Item
from .schemas import ItemCreate, ItemUpdate

class ItemRepository(BaseCRUD[Item, ItemCreate, ItemUpdate]):
    def __init__(self):
        super().__init__(Item)
    
    def create_item(
        self, session: Session, *, item_in: ItemCreate, owner_id: uuid.UUID
    ) -> Item:
        db_item = Item.model_validate(
            item_in, update={"owner_id": owner_id}
        )
        session.add(db_item)
        session.commit()
        session.refresh(db_item)
        return db_item
    
    def get_items_by_owner(
        self, session: Session, owner_id: uuid.UUID, skip: int = 0, limit: int = 100
    ) -> List[Item]:
        statement = (
            select(Item)
            .where(Item.owner_id == owner_id)
            .offset(skip)
            .limit(limit)
        )
        return session.exec(statement).all()

item_repository = ItemRepository()
```

## Service Pattern
```python
# service.py
import uuid
from typing import List, Optional
from sqlmodel import Session

from .models import Item
from .schemas import ItemCreate, ItemUpdate
from .repository import item_repository

class ItemService:
    def create_item(
        self, session: Session, item_in: ItemCreate, owner_id: uuid.UUID
    ) -> Item:
        return item_repository.create_item(
            session=session, item_in=item_in, owner_id=owner_id
        )
    
    def get_item(
        self, session: Session, item_id: uuid.UUID
    ) -> Optional[Item]:
        return item_repository.get(session, item_id)
    
    def get_items(
        self, session: Session, skip: int = 0, limit: int = 100
    ) -> List[Item]:
        return item_repository.get_multi(session, skip=skip, limit=limit)
    
    def update_item(
        self, session: Session, db_item: Item, item_in: ItemUpdate
    ) -> Item:
        return item_repository.update(
            session, db_obj=db_item, obj_in=item_in
        )

item_service = ItemService()
```

## API Endpoint Pattern
```python
# api/v1/endpoints/items.py
import uuid
from typing import Any

from fastapi import APIRouter, Depends, HTTPException
from sqlmodel import Session

from app.api.v1.dependencies import CurrentUser, SessionDep
from app.modules.items.schemas import ItemCreate, ItemPublic, ItemUpdate
from app.modules.items.service import item_service
from app.common.schemas.message import Message

router = APIRouter(prefix="/items", tags=["items"])

@router.post("/", response_model=ItemPublic)
def create_item(
    *, session: SessionDep, current_user: CurrentUser, item_in: ItemCreate
) -> Any:
    """Create new item."""
    return item_service.create_item(
        session=session, item_in=item_in, owner_id=current_user.id
    )

@router.get("/{id}", response_model=ItemPublic)
def read_item(
    session: SessionDep, current_user: CurrentUser, id: uuid.UUID
) -> Any:
    """Get item by ID."""
    item = item_service.get_item(session, item_id=id)
    if not item:
        raise HTTPException(status_code=404, detail="Item not found")
    
    if not current_user.is_superuser and (item.owner_id != current_user.id):
        raise HTTPException(status_code=400, detail="Not enough permissions")
    
    return item
```

## API Dependencies Pattern
```python
# api/v1/dependencies.py
from typing import Annotated
from fastapi import Depends
from sqlmodel import Session

from app.core.db import engine
from app.modules.users.models import User

def get_db():
    with Session(engine) as session:
        yield session

SessionDep = Annotated[Session, Depends(get_db)]
CurrentUser = Annotated[User, Depends(get_current_user)]
```

## Base CRUD Pattern
```python
# core/base_crud.py
from typing import Generic, List, Optional, TypeVar, Union
from uuid import UUID
from sqlmodel import Session, SQLModel, select
from pydantic import BaseModel

ModelType = TypeVar("ModelType", bound=SQLModel)
CreateSchemaType = TypeVar("CreateSchemaType", bound=BaseModel)
UpdateSchemaType = TypeVar("UpdateSchemaType", bound=BaseModel)

class BaseCRUD(Generic[ModelType, CreateSchemaType, UpdateSchemaType]):
    def __init__(self, model):
        self.model = model
    
    def get(self, session: Session, id: UUID) -> Optional[ModelType]:
        return session.get(self.model, id)
    
    def get_multi(
        self, session: Session, *, skip: int = 0, limit: int = 100
    ) -> List[ModelType]:
        statement = select(self.model).offset(skip).limit(limit)
        return session.exec(statement).all()
    
    def create(
        self, session: Session, *, obj_in: CreateSchemaType
    ) -> ModelType:
        obj_in_data = obj_in.model_dump()
        db_obj = self.model(**obj_in_data)
        session.add(db_obj)
        session.commit()
        session.refresh(db_obj)
        return db_obj
```

## Testing Pattern
```python
# tests/modules/test_items.py
import uuid
import pytest
from sqlmodel import Session
from app.modules.items.schemas import ItemCreate
from app.modules.items.service import item_service

def test_create_item(db: Session, test_user) -> None:
    item_in = ItemCreate(
        title="Test Item",
        description="Test Description"
    )
    item = item_service.create_item(
        session=db,
        item_in=item_in,
        owner_id=test_user.id
    )
    assert item.title == item_in.title
    assert item.description == item_in.description
    assert item.owner_id == test_user.id
```

## Database Migration Pattern
```python
# alembic/versions/xxxx_create_items_table.py
import sqlalchemy as sa
import sqlmodel
from alembic import op
import uuid
from sqlalchemy.dialects.postgresql import UUID

def upgrade() -> None:
    op.create_table(
        "item",
        sa.Column("id", UUID(as_uuid=True), primary_key=True, default=uuid.uuid4),
        sa.Column("title", sa.String(255), nullable=False),
        sa.Column("description", sa.String(255), nullable=True),
        sa.Column("owner_id", UUID(as_uuid=True), sa.ForeignKey("user.id"), nullable=False),
    )
    op.create_index(op.f("ix_item_id"), "item", ["id"], unique=True)

def downgrade() -> None:
    op.drop_index(op.f("ix_item_id"), table_name="item")
    op.drop_table("item")
```

## Development Practices
- Use `ruff` for linting
- Follow strict mypy typing
- Write unit tests for all modules
- Document API endpoints using docstrings
- Use meaningful commit messages

## Code Style
- Use Python 3.10+ features like `|` for union types
- Follow FastAPI best practices
- Use type annotations consistently
- Return appropriate HTTP status codes
- Validate input data using Pydantic models
